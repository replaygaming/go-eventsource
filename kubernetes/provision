#!/usr/bin/env ruby

class Provision
  class << self

    def call
      ensure_secret
      ensure_deployment
      say "EventSource provisioned successfully"
    end

    def ensure_secret
      return if Kernel.system(*%W[kubectl get secret/pubsub -o name], err: :out, out: "/dev/null")

      say "PubSub secrets are not configured. Make sure you have them provisioned from the infrastructure repository."
      exit 1
    end

    def ensure_deployment
      deployment_file = File.join(File.expand_path("..", __FILE__), "deployment.yaml")
      Kernel.system(*%W[kubectl apply -f #{deployment_file}], out: "/dev/null")
    end

    def say(message)
      puts message
    end
  end
end

Provision.call
